name: Build and deploy FastAPI app to Azure Web App

on:
  push:
    branches:
      - main  # 根据你的分支名称调整
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AZURE_WEBAPP_NAME: zdq-fastapi-webapp  # 替换为你的Azure Web App名称
  AZURE_WEBAPP_PACKAGE_PATH: '.'       # FastAPI应用的根目录
  AZURE_RESOURCE_GROUP: resource_chenlin  # 替换为你的Azure资源组名称
  LOCATION: eastus  # 替换为你的Azure区域，例如eastus
  # 需要在azure application app 中创建OCID 联合证书
  # 应用服务计划名称（与命令中一致）
  AZURE_APP_PLAN_NAME: zdq-fastapi-appplan
  

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest


    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'  # 更新为项目要求的Python版本

      # 新增步骤：安装依赖用于测试
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      # 新增步骤：测试应用是否能正常导入
      - name: Test application import
        run: |
          python -c "import main"
        
      # 新增步骤：创建.env文件（从Action Variables读取配置）
      - name: Create .env file from Action Variables
        run: |
          # 检查CSV_OUTPUT_PATH变量是否存在，不存在则设默认值（可选）
          if [ -z "${{ vars.CSV_OUTPUT_PATH }}" ]; then
            echo "CSV_OUTPUT_PATH=/app/data/output.csv" > .env
            echo "⚠️ CSV_OUTPUT_PATH变量未配置，已使用默认值：/app/data/output.csv"
          else
            echo "CSV_OUTPUT_PATH=${{ vars.CSV_OUTPUT_PATH }}" > .env
            echo "✅ 已从Variables读取并创建.env文件，值为：${{ vars.CSV_OUTPUT_PATH }}"
          fi
          # 验证.env文件内容（调试用，可删除）
          cat .env

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}


      - name: Ensure Web App is Running
        run: |
          # 确保Web App处于运行状态
          az webapp start \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }}
          # 显示Web App状态
          az webapp show \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "state"

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          package: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}
          resource-group-name: ${{ env.AZURE_RESOURCE_GROUP }}

      - name: Configure FastAPI startup command
        run: |
          # 配置Web App启动命令（适配Azure Linux Python环境）
          # 使用UvicornWorker来运行FastAPI应用
          az webapp config set \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --startup-file "gunicorn --workers=4 --worker-class=uvicorn.workers.UvicornWorker --bind=0.0.0.0 main:app"
          # 添加应用设置，启用SCM和指定Python版本
          az webapp config appsettings set \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --settings \
              WEBSITE_WEBDEPLOY_USE_SCM=true \
              SCM_DO_BUILD_DURING_DEPLOYMENT=true \
              PYTHONPATH="/home/site/wwwroot" \
              PYTHON_VERSION="3.13"
          # 设置Python版本
          az webapp config set \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --linux-fx-version "PYTHON|3.13"
          # 重启Web App以应用配置
          az webapp restart \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }}

      - name: Logout from Azure
        if: always()  # 无论前面步骤是否失败，都执行登出
        run: az logout || true