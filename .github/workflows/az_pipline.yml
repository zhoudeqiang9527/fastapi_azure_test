name: Build and deploy FastAPI app to Azure Web App

on:
  push:
    branches:
      - main  # 根据你的分支名称调整
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AZURE_WEBAPP_NAME: zdq-fastapi-app  # 替换为你的Azure Web App名称
  AZURE_WEBAPP_PACKAGE_PATH: '.'       # FastAPI应用的根目录
  AZURE_RESOURCE_GROUP: resource_chenlin  # 替换为你的Azure资源组名称
  LOCATION: eastus  # 替换为你的Azure区域，例如eastus
  # 需要在azure application app 中创建OCID 联合证书

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest


    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'  # 更新为项目要求的Python版本

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          enable-id-token-auth: true  # 启用 OIDC 身份验证

      - name: Create Azure Web App Service if not exists
        run: |
          az group create --name ${{ env.AZURE_RESOURCE_GROUP }} --location ${{ env.LOCATION }} || true
          az webapp create --name ${{ env.AZURE_WEBAPP_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --plan ${{ env.AZURE_WEBAPP_NAME }}_plan --runtime "PYTHON|3.13" --deployment-local-git || true

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          slot-name: 'Production'  # 如果需要部署到特定槽位，可以更改
          package: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}

      - name: Configure Web App Service to run FastAPI with Uvicorn
        run: |
          az webapp config set --name ${{ env.AZURE_WEBAPP_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --startup-file "uvicorn main:app --host 0.0.0.0 --port 8000"

      - name: Logout from Azure
        run: |
          az logout