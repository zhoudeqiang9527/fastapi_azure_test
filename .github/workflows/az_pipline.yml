name: Build and deploy FastAPI app to Azure Web App

on:
  push:
    branches:
      - main  # 根据你的分支名称调整
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AZURE_WEBAPP_NAME: zdq-fastapi-app  # 替换为你的Azure Web App名称
  AZURE_WEBAPP_PACKAGE_PATH: '.'       # FastAPI应用的根目录
  AZURE_RESOURCE_GROUP: resource_chenlin  # 替换为你的Azure资源组名称
  LOCATION: eastus  # 替换为你的Azure区域，例如eastus
  # 需要在azure application app 中创建OCID 联合证书
  # 应用服务计划名称（与命令中一致）
  AZURE_APP_PLAN_NAME: zdq-fastapi-app_plan

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest


    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'  # 更新为项目要求的Python版本

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      # 新增步骤：创建.env文件（从Action Variables读取配置）
      - name: Create .env file from Action Variables
        run: |
          # 检查CSV_OUTPUT_PATH变量是否存在，不存在则设默认值（可选）
          if [ -z "${{ vars.CSV_OUTPUT_PATH }}" ]; then
            echo "CSV_OUTPUT_PATH=/app/data/output.csv" > .env
            echo "⚠️ CSV_OUTPUT_PATH变量未配置，已使用默认值：/app/data/output.csv"
          else
            echo "CSV_OUTPUT_PATH=${{ vars.CSV_OUTPUT_PATH }}" > .env
            echo "✅ 已从Variables读取并创建.env文件，值为：${{ vars.CSV_OUTPUT_PATH }}"
          fi
          # 验证.env文件内容（调试用，可删除）
          cat .env

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Create Azure Resources (Group + Plan + Web App)
        run: |
          # 1. 创建资源组（已存在则跳过）
          az group create --name ${{ env.AZURE_RESOURCE_GROUP }} --location ${{ env.LOCATION }} || true
          
          # 2. 注册 Microsoft.Web 命名空间（关键修复）
          az provider register --namespace Microsoft.Web || true
          # 等待注册完成（最多等待5分钟，轮询检查状态）
          timeout=300  # 5分钟超时
          elapsed=0
          while [ "$(az provider show --namespace Microsoft.Web --query "registrationState" --output tsv)" != "Registered" ] && [ $elapsed -lt $timeout ]; do
            echo "Microsoft.Web 命名空间正在注册中，已等待 $elapsed 秒..."
            sleep 30
            elapsed=$((elapsed + 30))
          done
          # 检查最终注册状态
          if [ "$(az provider show --namespace Microsoft.Web --query "registrationState" --output tsv)" != "Registered" ]; then
            echo "❌ Microsoft.Web 命名空间注册超时，请手动注册后重试！"
            exit 1
          fi
          
          # 3. 创建Linux应用服务计划
          az appservice plan create \
            --name ${{ env.AZURE_APP_PLAN_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --location ${{ env.LOCATION }} \
            --sku F1 \
            --is-linux \
            --number-of-workers 1 || true
          
          # 3. 创建Web App（依赖上面的计划）
          az webapp create \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --plan ${{ env.AZURE_APP_PLAN_NAME }} \
            --runtime "PYTHON|3.13" || true

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          slot-name: 'Production'
          package: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}
          resource-group: ${{ env.AZURE_RESOURCE_GROUP }}

      - name: Configure FastAPI startup command
        run: |
          # 配置Web App启动命令（适配Azure Linux Python环境）
          az webapp config set \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --startup-file "gunicorn --bind=0.0.0.0 --workers=4 main:app"
          # 注：Azure Linux Web App推荐用gunicorn而非uvicorn（更稳定）

      - name: Logout from Azure
        if: always()  # 无论前面步骤是否失败，都执行登出
        run: az logout || true